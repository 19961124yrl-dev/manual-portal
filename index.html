<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ•°å­—æ‰‹å†Œ</title>
    <script src="data.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: #f4f4f4; }
        header { 
            background-color: #004d99; color: white; padding: 15px; 
            text-align: center; position: relative; display: flex; 
            justify-content: center; align-items: center; min-height: 50px;
        }
        header h1 { margin: 0; font-size: 1.3rem; max-width: 60%; }
        .header-controls { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px; }
        .ctrl-btn { border: none; border-radius: 4px; color: white; padding: 8px 12px; cursor: pointer; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-export { background-color: #f39c12; }
        .btn-add { background-color: #28a745; font-size: 18px; line-height: 1; }
        .container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .menu-item-wrapper { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; }
        .menu-item { background: white; border: 1px solid #ddd; padding: 18px; border-radius: 6px; cursor: pointer; flex-grow: 1; }
        .edit-btn { background: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; min-width: 60px; }
        .back-button { display: block; width: 100%; margin-bottom: 12px; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .pdf-link { display: block; background: #eef7ff; color: #004d99; padding: 15px; margin-top: 10px; border-radius: 5px; text-decoration: none; border-left: 5px solid #004d99; font-weight: bold; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 350px; text-align: center; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-modal { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <h1 id="pageTitle">ä¸»ä»»çº§æ•°å­—æ‰‹å†Œ</h1>
        <div class="header-controls">
            <button class="ctrl-btn btn-export" onclick="exportData()">ğŸ’¾ å¯¼å‡º</button>
            <button class="ctrl-btn btn-add" onclick="handleGlobalAdd()">ï¼‹</button>
        </div>
    </header>

    <div class="container">
        <button id="backButton" class="back-button" style="display:none;">â† è¿”å›ä¸Šä¸€çº§</button>
        <div id="content"></div>
    </div>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal">
            <h3 id="modalTitle">ç®¡ç†é¡¹ç›®</h3>
            <div class="modal-btns">
                <button class="btn-modal" style="background:#007bff;color:white;" id="modalRenameBtn">âœï¸ ä¿®æ”¹åç§°</button>
                <button class="btn-modal" style="background:#ff4d4d;color:white;" id="modalDeleteBtn">ğŸ—‘ï¸ åˆ é™¤æ­¤é¡¹</button>
                <button class="btn-modal" style="background:#eee;color:#666;" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // åˆå§‹åŒ–æ•°æ®ï¼Œé˜²æ­¢ data.js ç¼ºå¤±å¯¼è‡´æŠ¥é”™
        window.EQUIPMENT_DATA = window.EQUIPMENT_DATA || {};

        const contentDiv = document.getElementById('content');
        const pageTitle = document.getElementById('pageTitle');
        const backButton = document.getElementById('backButton');
        const modalOverlay = document.getElementById('modalOverlay');

        // --- æ ¸å¿ƒï¼šç»Ÿä¸€å¢åŠ æŒ‰é’®é€»è¾‘ ---
        function handleGlobalAdd() {
            const hash = window.location.hash.slice(1);
            if (!hash) {
                addItem('L0');
            } else {
                const [level, params] = hash.split('=');
                const keys = params.split(',');
                if (level === 'L1') addItem('L1', keys[0]);
                else if (level === 'L2') addItem('L2', keys[0], keys[1]);
            }
        }

        function addItem(level, devKey = null, modKey = null) {
            const name = prompt("è¯·è¾“å…¥åç§°:");
            if (!name) return;

            if (level === 'L0') {
                const newKey = 'dev_' + Date.now();
                EQUIPMENT_DATA[newKey] = { name: name, modules: {} };
            } else if (level === 'L1') {
                const newModKey = 'mod_' + Date.now();
                EQUIPMENT_DATA[devKey].modules[newModKey] = { name: name, subcomponents: {} };
            } else if (level === 'L2') {
                const pdfFile = prompt("è¯·è¾“å…¥ PDF æ–‡ä»¶å (å¦‚: 123.pdf):", "");
                if (!pdfFile) return;
                const subKey = 'sub_' + Date.now();
                EQUIPMENT_DATA[devKey].modules[modKey].subcomponents = EQUIPMENT_DATA[devKey].modules[modKey].subcomponents || {};
                EQUIPMENT_DATA[devKey].modules[modKey].subcomponents[subKey] = {
                    name: name,
                    processes: [{ name: name, pdf: "pdfs/" + pdfFile.replace('pdfs/', '') }]
                };
            }
            handleRoute(); // åˆ·æ–°å½“å‰é¡µé¢æ˜¾ç¤º
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = "window.EQUIPMENT_DATA = " + JSON.stringify(EQUIPMENT_DATA, null, 4) + ";";
            const blob = new Blob([dataStr], { type: "text/javascript" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "data.js";
            a.click();
            alert("è´¦æœ¬å·²ç”Ÿæˆï¼è¯·è¦†ç›–æ–‡ä»¶å¤¹é‡Œçš„ data.js æ–‡ä»¶ã€‚");
        }

        // æ’åº
        function getSortedKeys(obj) {
            if (!obj) return [];
            return Object.keys(obj).sort((a, b) => obj[a].name.localeCompare(obj[b].name, 'zh-Hans-CN'));
        }

        // ç®¡ç†å¼¹çª—
        function openModal(e, level, k1, k2 = null, k3 = null) {
            e.stopPropagation();
            let obj;
            if (level === 'L0') obj = EQUIPMENT_DATA[k1];
            else if (level === 'L1') obj = EQUIPMENT_DATA[k1].modules[k2];
            else if (level === 'L2') obj = EQUIPMENT_DATA[k1].modules[k2].subcomponents[k3];
            
            document.getElementById('modalTitle').innerText = "ç®¡ç†: " + obj.name;
            modalOverlay.style.display = 'flex';
            
            document.getElementById('modalRenameBtn').onclick = () => {
                const newName = prompt("æ–°åç§°:", obj.name);
                if (newName) { obj.name = newName; closeModal(); handleRoute(); }
            };
            document.getElementById('modalDeleteBtn').onclick = () => {
                if (confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ")) {
                    if (level === 'L0') delete EQUIPMENT_DATA[k1];
                    else if (level === 'L1') delete EQUIPMENT_DATA[k1].modules[k2];
                    else if (level === 'L2') delete EQUIPMENT_DATA[k1].modules[k2].subcomponents[k3];
                    closeModal(); handleRoute();
                }
            };
        }
        function closeModal() { modalOverlay.style.display = 'none'; }

        // æ¸²æŸ“å‡½æ•°ç»„
        function renderL0() {
            pageTitle.innerText = 'è®¾å¤‡æ€»è§ˆ (L0)';
            contentDiv.innerHTML = ''; backButton.style.display = 'none';
            getSortedKeys(EQUIPMENT_DATA).forEach(key => {
                contentDiv.innerHTML += `
                    <div class="menu-item-wrapper">
                        <div class="menu-item" onclick="window.location.hash='#L1=${key}'"><h2>${EQUIPMENT_DATA[key].name}</h2></div>
                        <button class="edit-btn" onclick="openModal(event, 'L0', '${key}')">ç®¡ç†</button>
                    </div>`;
            });
        }

        function renderL1(dk) {
            const dev = EQUIPMENT_DATA[dk];
            pageTitle.innerText = dev.name + ' (L1)';
            contentDiv.innerHTML = ''; backButton.style.display = 'block';
            getSortedKeys(dev.modules).forEach(mk => {
                contentDiv.innerHTML += `
                    <div class="menu-item-wrapper">
                        <div class="menu-item" onclick="window.location.hash='#L2=${dk},${mk}'"><h2>${dev.modules[mk].name}</h2></div>
                        <button class="edit-btn" onclick="openModal(event, 'L1', '${dk}', '${mk}')">ç®¡ç†</button>
                    </div>`;
            });
        }

        function renderL2(dk, mk) {
            const mod = EQUIPMENT_DATA[dk].modules[mk];
            pageTitle.innerText = mod.name + ' (L2)';
            contentDiv.innerHTML = ''; backButton.style.display = 'block';
            getSortedKeys(mod.subcomponents || {}).forEach(sk => {
                let html = `<div class="menu-item-wrapper"><div class="menu-item"><h2>${mod.subcomponents[sk].name}</h2>`;
                mod.subcomponents[sk].processes.forEach(p => { html += `<a href="${p.pdf}" target="_blank" class="pdf-link">ğŸ“„ ç‚¹å‡»æ‰“å¼€ PDF éªŒæ”¶æ‰‹å†Œ</a>`; });
                html += `</div><button class="edit-btn" onclick="openModal(event, 'L2', '${dk}', '${mk}', '${sk}')">ç®¡ç†</button></div>`;
                contentDiv.innerHTML += html;
            });
        }

        function handleRoute() {
            const hash = window.location.hash.slice(1);
            if (!hash) { renderL0(); return; }
            const [level, params] = hash.split('=');
            const keys = params.split(',');
            if (level === 'L1') { 
                renderL1(keys[0]); 
                backButton.onclick = () => window.location.hash = ''; 
            } else if (level === 'L2') { 
                renderL2(keys[0], keys[1]); 
                backButton.onclick = () => window.location.hash = `#L1=${keys[0]}`; 
            }
        }

        window.addEventListener('hashchange', handleRoute);
        handleRoute(); 
    </script>
</body>
</html>