<!DOCTYPE html>
<html lang="zh-CN">
<head>AI
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸»ä»»çº§æ•°å­—æ‰‹å†Œ - ç¨³å®šè´¦æœ¬ç‰ˆ</title>
  <script src="data.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background-color: #f4f4f4; color: #333; }

    header {
      background-color: #004d99; color: white; padding: 15px;
      text-align: center; position: relative; display: flex;
      justify-content: center; align-items: center; min-height: 50px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    header h1 { margin: 0; font-size: 1.3rem; max-width: 60%; }

    .header-controls {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end;
    }
    .ctrl-btn {
      border: none; border-radius: 4px; color: white; padding: 8px 12px;
      cursor: pointer; font-weight: bold; font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-export { background-color: #f39c12; }
    .btn-add { background-color: #28a745; font-size: 18px; line-height: 1; }
    .btn-scan { background-color: #8e44ad; }

    .container { padding: 15px; max-width: 900px; margin: 0 auto; }

    /* L0/L1 ç»´æŒä½ åŸæ¥çš„åˆ—è¡¨ */
    .menu-item-wrapper { display: flex; align-items: flex-start; margin-bottom: 12px; gap: 10px; }
    .menu-item { background: white; border: 1px solid #ddd; padding: 18px; border-radius: 6px; cursor: pointer; flex-grow: 1; transition: 0.2s; }
    .menu-item:hover { background-color: #fcfcfc; border-color: #004d99; }
    .menu-item h2 { margin: 0; font-size: 1.1rem; }

    .edit-btn { background: #007bff; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; min-width: 60px; }
    .back-button { display: block; width: 100%; margin-bottom: 12px; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }

    /* PDF æŒ‰é’®ä¿æŒåŸæ · */
    .pdf-link { display: block; background: #eef7ff; color: #004d99; padding: 15px; margin-top: 10px; border-radius: 5px; text-decoration: none; border-left: 5px solid #004d99; font-weight: bold; }

    /* å¼¹çª— */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
    .modal { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .btn-modal { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }

    /* âœ… ä½ åŸæ¥çš„â€œå°å›¾ gridâ€ï¼Œä¿ç•™ï¼ˆç»™é¢„è§ˆ/å¤‡ç”¨ç”¨ï¼‰ */
    .asset-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 700px){
      .asset-grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 450px){
      .asset-grid{ grid-template-columns: repeat(1, 1fr); }
    }
    .asset-tile{
      background:#fff;
      border:1px solid #ddd;
      border-radius:10px;
      overflow:hidden;
      cursor:pointer;
      transition:0.15s;
    }
    .asset-tile:hover{
      border-color:#004d99;
      transform: translateY(-1px);
    }
    .asset-thumb{
      width:100%;
      height:160px;
      object-fit:cover;
      display:block;
    }

    .hint { font-size:12px; color:#666; line-height:1.6; margin-top:8px; text-align:left; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* =====================================================
       âœ… æ–°å¢ï¼šL2 ç›¸å†Œå¼å¹³é“ºï¼ˆè§£å†³â€œå›¾ç‰‡æ’åˆ—/æ‰‹æœºä¸å‹å¥½â€ï¼‰
       ===================================================== */

    /* L2 é¡µé¢æ•´ä½“ç½‘æ ¼ï¼šè‡ªåŠ¨é€‚é…åˆ—æ•° */
    .l2-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .l2-card{
      background:#fff;
      border:1px solid #ddd;
      border-radius:12px;
      overflow:hidden;
      cursor:pointer;
      transition: 0.15s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      position: relative;
      display:flex;
      flex-direction:column;
    }
    .l2-card:hover{
      border-color:#004d99;
      transform: translateY(-1px);
    }

    .l2-thumb{
      width:100%;
      height: 160px;
      object-fit: cover;
      display:block;
      background:#eee;
    }

    .l2-body{
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-height: 74px;
    }

    .l2-title{
      font-size: 14px;
      font-weight: 700;
      line-height: 1.35;
      margin: 0;
    }
    .l2-sub{
      font-size: 12px;
      color:#666;
      line-height: 1.35;
    }

    /* å³ä¸Šè§’ç®¡ç†æŒ‰é’®ï¼šä¸å å¸ƒå±€å®½åº¦ï¼Œä¸æŒ¤å‹å›¾ç‰‡/ç½‘æ ¼ */
    .l2-manage{
      position:absolute;
      top: 10px;
      right: 10px;
      border:none;
      background: rgba(0,77,153,0.92);
      color:#fff;
      padding: 8px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 700;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }
    .l2-manage:hover{
      background: rgba(0,77,153,1);
    }

    /* å°å±ç¨å¾®å¢é«˜å°é¢ï¼Œæ–¹ä¾¿ç‚¹æŒ‰ */
    @media (max-width: 420px){
      .l2-thumb{ height: 180px; }
    }

    /* L2 é¢„è§ˆå¼¹çª—çš„å®½åº¦ä¿æŒä½ åŸæ¥ */
  </style>
</head>
<body>
<header>
  <h1 id="pageTitle">ä¸»ä»»çº§æ•°å­—æ‰‹å†Œ</h1>
  <div class="header-controls">
    <button class="ctrl-btn btn-export" onclick="exportData()" title="ä¸‹è½½æœ€æ–° data.js">ğŸ’¾ å¯¼å‡º</button>
    <button id="scanBtn" class="ctrl-btn btn-scan" onclick="triggerLocalScan()" title="ä»…æœ¬åœ°ï¼šæ‰«æç›®å½•ï¼ŒæŠŠæ–‡ä»¶æ”¾å…¥å½“å‰æ–‡ä»¶å¤¹">ğŸ§­ æœ¬åœ°æ‰«æ</button>
    <button class="ctrl-btn btn-add" onclick="handleGlobalAdd()" title="æ·»åŠ æ–°é¡¹">ï¼‹</button>
  </div>
</header>

<div class="container">
  <button id="backButton" class="back-button" style="display:none;">â† è¿”å›ä¸Šä¸€çº§</button>
  <div id="content"></div>
  <div class="hint" id="localHint" style="display:none;">
    æœ¬åœ°æ‰«æè¯´æ˜ï¼šä½ éœ€è¦å…ˆè¿›å…¥æŸä¸ªâ€œæ–‡ä»¶å¤¹â€ï¼ˆä¾‹å¦‚ã€å‡ºè·å†™çœŸã€‘ï¼‰å†ç‚¹æ‰«æã€‚æ‰«æç»“æœä¼šç›´æ¥è¿½åŠ åˆ°å½“å‰æ–‡ä»¶å¤¹ä¸‹ã€‚<br/>
    ä½ å¯ä»¥é€‰æ ¹ç›®å½•ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€‰ <span class="mono">images</span> æˆ– <span class="mono">pdfs</span>ï¼Œç”šè‡³ç›´æ¥é€‰æŸä¸ªå…·ä½“åˆ†ç±»æ–‡ä»¶å¤¹ã€‚<br/>
    æ‰«æåè®°å¾—ç‚¹ <strong>ğŸ’¾ å¯¼å‡º</strong> è¦†ç›– <span class="mono">data.js</span>ã€‚
  </div>
</div>

<!-- ç®¡ç†å¼¹çª— -->
<div id="modalOverlay" class="modal-overlay">
  <div class="modal">
    <h3 id="modalTitle">ç®¡ç†é¡¹ç›®</h3>
    <div class="modal-btns">
      <button class="btn-modal" style="background:#007bff;color:white;" id="modalRenameBtn">âœï¸ ä¿®æ”¹åç§°</button>
      <button class="btn-modal" style="background:#ff4d4d;color:white;" id="modalDeleteBtn">ğŸ—‘ï¸ åˆ é™¤æ­¤é¡¹</button>
      <button class="btn-modal" style="background:#eee;color:#666;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- é¢„è§ˆå¼¹çª— -->
<div id="viewerOverlay" class="modal-overlay">
  <div class="modal" style="max-width: 980px; width: 92%; padding: 12px; text-align:left;">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <h3 id="viewerTitle" style="margin:0;">é¢„è§ˆ</h3>
      <button class="btn-modal" style="background:#eee;color:#666; padding:8px 12px;" onclick="closeViewer()">å…³é—­</button>
    </div>
    <div id="viewerBody" style="margin-top:10px; text-align:center;"></div>
  </div>
</div>

<!-- æœ¬åœ°æ‰«æï¼šç›®å½•é€‰æ‹©å™¨ -->
<input id="dirPicker" type="file" style="display:none;" webkitdirectory multiple />

<script>
  window.EQUIPMENT_DATA = window.EQUIPMENT_DATA || {};

  const contentDiv = document.getElementById('content');
  const pageTitle = document.getElementById('pageTitle');
  const backButton = document.getElementById('backButton');
  const modalOverlay = document.getElementById('modalOverlay');

  const viewerOverlay = document.getElementById('viewerOverlay');
  const viewerTitle = document.getElementById('viewerTitle');
  const viewerBody = document.getElementById('viewerBody');

  const scanBtn = document.getElementById('scanBtn');
  const localHint = document.getElementById('localHint');
  const dirPicker = document.getElementById('dirPicker');

  // ===== å·¥å…·å‡½æ•° =====
  function isImageExt(ext){ return ['png','jpg','jpeg','webp','gif','bmp','svg'].includes(ext); }
  function safeJsString(s){ return (s||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
  function normalize(s){ return (s||'').trim().replace(/^\/+|\/+$/g,''); }
  function safePathSegment(name){
  // æŠŠè®¾å¤‡åå˜æˆâ€œå¯å½“æ–‡ä»¶å¤¹åâ€çš„å½¢å¼ï¼ˆå»æ‰æ–œæ ç­‰å±é™©å­—ç¬¦ï¼‰
  return (name || 'unknown')
    .trim()
    .replace(/[\\\/:*?"<>|]/g, '_')
    .replace(/\s+/g, ' ')
    .trim();
}
function getDeviceFolderName(dk){
  const devName = EQUIPMENT_DATA?.[dk]?.name || dk || 'unknown';
  return safePathSegment(devName);
}

  function baseNameNoExt(path){
    const name = (path || '').split('/').pop() || '';
    const i = name.lastIndexOf('.');
    return i > 0 ? name.slice(0,i) : name;
  }
  function getSortedKeys(obj){
    if (!obj) return [];
    return Object.keys(obj).sort((a,b)=>(obj[a].name||'').localeCompare((obj[b].name||''),'zh-Hans-CN'));
  }

  // ç»™ L2 å¡ç‰‡ç”¨ï¼šç”Ÿæˆå ä½å°é¢
  function makePlaceholderDataUri(text){
    const t = (text || 'NO COVER').slice(0, 20);
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="800" height="450">
        <rect width="100%" height="100%" fill="#e5e7eb"/>
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
          fill="#6b7280" font-size="28" font-family="Arial">${t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</text>
      </svg>`;
    return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
  }

  // ===== ä¸Šçº¿éšè—æœ¬åœ°æ‰«æ =====
  (function initLocalScanAvailability(){
    const isFile = location.protocol === 'file:';
    const isLocalHost = ['localhost','127.0.0.1'].includes(location.hostname);
    const ok = isFile || isLocalHost;
    if(ok){
      localHint.style.display = 'block';
    }else{
      scanBtn.style.display = 'none';
    }
  })();

  // ===== è¯»å–â€œå½“å‰æ‰€åœ¨æ–‡ä»¶å¤¹ï¼ˆæ¨¡å—ï¼‰â€ =====
  function getCurrentRoute(){
    const hash = window.location.hash.slice(1);
    if(!hash) return { level:'L0', dk:null, mk:null };
    const [level, params] = hash.split('=');
    const keys = (params || '').split(',');
    if(level === 'L1') return { level:'L1', dk: keys[0], mk:null };
    if(level === 'L2') return { level:'L2', dk: keys[0], mk: keys[1] };
    return { level:'L0', dk:null, mk:null };
  }

  // ===== å¯¼å‡º =====
  function exportData(){
    const dataStr = "window.EQUIPMENT_DATA = " + JSON.stringify(EQUIPMENT_DATA, null, 4) + ";";
    const blob = new Blob([dataStr], { type: "text/javascript" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "data.js";
    a.click();
    alert("å·²å¯¼å‡º data.jsï¼ˆè¯·ç”¨å®ƒè¦†ç›–é¡¹ç›®é‡Œçš„ data.jsï¼Œç„¶ååˆ·æ–°é¡µé¢ï¼‰");
  }

  // ===== æ‰‹åŠ¨æ·»åŠ ï¼ˆä¿ç•™ï¼‰ =====
  function handleGlobalAdd() {
    const hash = window.location.hash.slice(1);
    if (!hash) addItem('L0');
    else {
      const [level, params] = hash.split('=');
      const keys = params.split(',');
      if (level === 'L1') addItem('L1', keys[0]);
      else if (level === 'L2') addItem('L2', keys[0], keys[1]);
    }
  }

  function addItem(level, devKey=null, modKey=null){
    const name = prompt("è¯·è¾“å…¥åç§°:");
    if(!name) return;

    if(level==='L0'){
      const newKey='dev_'+Date.now();
      EQUIPMENT_DATA[newKey]={ name, modules:{} };
    }else if(level==='L1'){
      const newModKey='mod_'+Date.now();
      EQUIPMENT_DATA[devKey].modules = EQUIPMENT_DATA[devKey].modules || {};
      EQUIPMENT_DATA[devKey].modules[newModKey]={ name, subcomponents:{} };
    }else if(level==='L2'){
      const file = prompt("è¾“å…¥æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼ˆå«è®¾å¤‡å/å­ç›®å½•ï¼‰ï¼Œä¾‹å¦‚ï¼šAI12/xx.pdf æˆ– AI12/a.png","");
      if(!file) return;
      const clean0 = file.replace(/^\/?pdfs\//,'').replace(/^\/?images\//,'');
      const ext = (clean0.split('.').pop()||'').toLowerCase();

      const devFolder = getDeviceFolderName(devKey);

      // å¦‚æœç”¨æˆ·æ²¡å†™ â€œè®¾å¤‡å/â€ï¼Œå°±è‡ªåŠ¨è¡¥ä¸Š
      let clean = clean0;
      const firstSeg = (clean.split('/')[0] || '').trim();
      if(firstSeg !== devFolder){
        clean = `${devFolder}/${clean}`;
      }

      const path = (ext==='pdf') ? ("pdfs/"+clean) : ("images/"+clean);


      const mod = EQUIPMENT_DATA[devKey].modules[modKey];
      mod.subcomponents = mod.subcomponents || {};
      const subKey='sub_'+Date.now();
      mod.subcomponents[subKey]={
        name,
        processes:[{ name, file:path, ext }]
      };
    }
    handleRoute();
  }

  // ===== ç®¡ç†å¼¹çª— =====
  function openModal(e, level, k1, k2=null, k3=null){
    e.stopPropagation();
    let obj;
    if(level==='L0') obj=EQUIPMENT_DATA[k1];
    else if(level==='L1') obj=EQUIPMENT_DATA[k1].modules[k2];
    else obj=EQUIPMENT_DATA[k1].modules[k2].subcomponents[k3];

    document.getElementById('modalTitle').innerText = "ç®¡ç†: " + (obj?.name||'');
    modalOverlay.style.display='flex';

    document.getElementById('modalRenameBtn').onclick=()=>{
      const newName=prompt("æ–°åç§°:", obj.name);
      if(newName){ obj.name=newName; closeModal(); handleRoute(); }
    };
    document.getElementById('modalDeleteBtn').onclick=()=>{
      if(confirm(`ç¡®å®šåˆ é™¤ [${obj.name}] ?`)){
        if(level==='L0') delete EQUIPMENT_DATA[k1];
        else if(level==='L1') delete EQUIPMENT_DATA[k1].modules[k2];
        else delete EQUIPMENT_DATA[k1].modules[k2].subcomponents[k3];
        closeModal(); handleRoute();
      }
    };
  }
  function closeModal(){ modalOverlay.style.display='none'; }

  // ===== é¢„è§ˆå¼¹çª— =====
  function closeViewer(){ viewerOverlay.style.display='none'; viewerBody.innerHTML=''; }
  viewerOverlay.addEventListener('click', (e)=>{ if(e.target===viewerOverlay) closeViewer(); });

  function openFile(filePath, titleText='é¢„è§ˆ'){
    const ext=(filePath.split('.').pop()||'').toLowerCase();
    if(ext==='pdf'){ window.open(filePath,'_blank'); return; }
    if(isImageExt(ext)){
      viewerTitle.innerText=titleText||'å›¾ç‰‡é¢„è§ˆ';
      viewerBody.innerHTML=`
        <img src="${filePath}" style="max-width:100%; max-height:78vh; border-radius:12px;" />
        <div style="margin-top:10px;">
          <a href="${filePath}" target="_blank" class="pdf-link" style="display:inline-block;">åœ¨æ–°æ ‡ç­¾æ‰“å¼€åŸå›¾</a>
        </div>`;
      viewerOverlay.style.display='flex';
      return;
    }
    window.open(filePath,'_blank');
  }

  // ===== æ¸²æŸ“ =====
  function renderL0(){
    pageTitle.innerText='è®¾å¤‡æ€»è§ˆ (L0)';
    contentDiv.innerHTML=''; backButton.style.display='none';
    getSortedKeys(EQUIPMENT_DATA).forEach(key=>{
      contentDiv.innerHTML+=`
        <div class="menu-item-wrapper">
          <div class="menu-item" onclick="window.location.hash='#L1=${key}'"><h2>${EQUIPMENT_DATA[key].name}</h2></div>
          <button class="edit-btn" onclick="openModal(event,'L0','${key}')">ç®¡ç†</button>
        </div>`;
    });
  }

  function renderL1(dk){
    const dev=EQUIPMENT_DATA[dk];
    pageTitle.innerText=dev.name;
    contentDiv.innerHTML=''; backButton.style.display='block';
    getSortedKeys(dev.modules||{}).forEach(mk=>{
      contentDiv.innerHTML+=`
        <div class="menu-item-wrapper">
          <div class="menu-item" onclick="window.location.hash='#L2=${dk},${mk}'"><h2>${dev.modules[mk].name}</h2></div>
          <button class="edit-btn" onclick="openModal(event,'L1','${dk}','${mk}')">ç®¡ç†</button>
        </div>`;
    });
  }

  /* =====================================================
     âœ… å…³é”®æ”¹åŠ¨ï¼šé‡å†™ renderL2
     - ä¸å†ç”¨ menu-item-wrapper çš„ flex åˆ—è¡¨ï¼ˆä¼šæŒ¤å‹å›¾ç‰‡ï¼‰
     - æ”¹æˆ l2-grid ç›¸å†Œå¼å¹³é“º
     - æ¯ä¸ªå­é¡¹ sc ä¸€å¼ å¡ç‰‡ï¼šå°é¢å›¾ + æ ‡é¢˜ + æ–‡ä»¶æ•°é‡
     - å³ä¸Šè§’â€œç®¡ç†â€æŒ‰é’®ç»å¯¹å®šä½ï¼Œä¸å½±å“å¸ƒå±€
     - ç‚¹å‡»å¡ç‰‡ï¼šä¼˜å…ˆæ‰“å¼€ç¬¬ä¸€å¼ å›¾ç‰‡ï¼›æ²¡æœ‰å›¾ç‰‡åˆ™æ‰“å¼€ç¬¬ä¸€ä¸ª PDFï¼›éƒ½æ²¡æœ‰å°±ä¸åŠ¨ä½œ
     ===================================================== */
 function renderL2(dk,mk){
  const mod=EQUIPMENT_DATA[dk].modules[mk];
  pageTitle.innerText=mod.name;
  contentDiv.innerHTML=''; backButton.style.display='block';

  const keys = getSortedKeys(mod.subcomponents||{});
  if(keys.length === 0){
    contentDiv.innerHTML = `<div class="hint">å½“å‰æ–‡ä»¶å¤¹æ²¡æœ‰å†…å®¹ã€‚ä½ å¯ä»¥ç‚¹å³ä¸Šè§’ â€œï¼‹â€ æ·»åŠ ï¼Œæˆ–è€…ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰ç”¨ ğŸ§­ æ‰«æã€‚</div>`;
    return;
  }

  // åˆ†æµï¼šæœ‰å›¾çš„è¿›ç›¸å†Œï¼›çº¯PDF/å…¶å®ƒçš„èµ°ä½ åŸæ¥çš„çºµå‘åˆ—è¡¨
  const photoCards = [];
  const pdfListRows = [];

  keys.forEach(sk=>{
    const sc=mod.subcomponents[sk];
    const processes = sc.processes || [];

    const images=[]; const pdfs=[]; const others=[];
    processes.forEach(p=>{
      const fp=p.file || p.pdf;
      if(!fp) return;
      const ext=(fp.split('.').pop()||'').toLowerCase();
      const title=p.name || sc.name || fp.split('/').pop();
      if(ext==='pdf') pdfs.push({fp,title,ext});
      else if(isImageExt(ext)) images.push({fp,title,ext});
      else others.push({fp,title,ext});
    });

    // ========= 1) æœ‰å›¾ç‰‡ï¼šç›¸å†Œå¡ç‰‡ =========
    if(images.length){
      const cover = images[0]?.fp || makePlaceholderDataUri(sc.name || 'NO COVER');

      // ç‚¹å‡»å¡ç‰‡æ‰“å¼€ç¬¬ä¸€å¼ å›¾
      const openTarget = images[0].fp;
      const openTitle  = images[0].title || sc.name || 'é¢„è§ˆ';

      const fileCount = images.length + pdfs.length + others.length;
      const summary = `${images.length} å›¾ / ${pdfs.length} PDF` + (others.length ? ` / ${others.length} å…¶ä»–` : '');

      photoCards.push(`
        <div class="l2-card" onclick="openFile('${safeJsString(openTarget)}','${safeJsString(openTitle)}')">
          <img class="l2-thumb" src="${cover}" alt="${sc.name || ''}">
          <button class="l2-manage" onclick="openModal(event,'L2','${dk}','${mk}','${sk}')">ç®¡ç†</button>
          <div class="l2-body">
            <div class="l2-title">${sc.name || '(æœªå‘½å)'}</div>
            <div class="l2-sub">${summary} Â· å…± ${fileCount} ä¸ª</div>
          </div>
        </div>
      `);
      return;
    }

    // ========= 2) æ²¡å›¾ç‰‡ï¼ˆçº¯PDF/å…¶å®ƒï¼‰ï¼šæ¢å¤çºµå‘åˆ—è¡¨ =========
    // ç‚¹å‡»æ•´å—æ—¶ï¼šä¼˜å…ˆæ‰“å¼€ç¬¬ä¸€ä¸ªPDFï¼Œå¦åˆ™æ‰“å¼€ç¬¬ä¸€ä¸ªå…¶å®ƒæ–‡ä»¶
    const openTarget = (pdfs[0]?.fp || others[0]?.fp || null);
    const openTitle  = (pdfs[0]?.title || others[0]?.title || sc.name || 'é¢„è§ˆ');

    let inner = `
      <div class="menu-item" ${openTarget ? `onclick="openFile('${safeJsString(openTarget)}','${safeJsString(openTitle)}')"` : ''}>
        <h2>${sc.name || '(æœªå‘½å)'}</h2>
    `;

    // ä¿æŒä½ åŸæ¥çš„ PDF æŒ‰é’®å½¢å¼
    pdfs.forEach(it=>{
      inner += `<a href="javascript:void(0)" onclick="openFile('${safeJsString(it.fp)}','${safeJsString(it.title)}')" class="pdf-link">ğŸ“„ ç‚¹å‡»æ‰“å¼€ PDF</a>`;
    });
    others.forEach(it=>{
      inner += `<a href="javascript:void(0)" onclick="openFile('${safeJsString(it.fp)}','${safeJsString(it.title)}')" class="pdf-link">ğŸ“ æ‰“å¼€æ–‡ä»¶</a>`;
    });

    inner += `</div>`;

    pdfListRows.push(`
      <div class="menu-item-wrapper">
        ${inner}
        <button class="edit-btn" onclick="openModal(event,'L2','${dk}','${mk}','${sk}')">ç®¡ç†</button>
      </div>
    `);
  });

  // è¾“å‡ºï¼šå…ˆç…§ç‰‡ç›¸å†Œï¼Œå†PDFåˆ—è¡¨
  let html = '';

  if(photoCards.length){
    html += `<div class="hint" style="margin:6px 0 10px;">ğŸ“· ç…§ç‰‡</div>`;
    html += `<div class="l2-grid">${photoCards.join('')}</div>`;
  }

  if(pdfListRows.length){
    html += `<div class="hint" style="margin:14px 0 10px;">ğŸ“„ PDF / å…¶ä»–æ–‡ä»¶</div>`;
    html += pdfListRows.join('');
  }

  contentDiv.innerHTML = html;
}


  // ===== è·¯ç”± =====
  function handleRoute(){
    const hash=window.location.hash.slice(1);
    if(!hash){ renderL0(); return; }
    const [level, params]=hash.split('=');
    const keys=(params||'').split(',');
    if(level==='L1'){ renderL1(keys[0]); backButton.onclick=()=>window.location.hash=''; }
    else if(level==='L2'){ renderL2(keys[0],keys[1]); backButton.onclick=()=>window.location.hash=`#L1=${keys[0]}`; }
    else renderL0();
  }
  window.addEventListener('hashchange', handleRoute);
  handleRoute();

  // =====================================================
  // âœ… æœ¬åœ°æ‰«æï¼ˆä¿æŒä½ åŸé€»è¾‘ä¸åŠ¨ï¼‰
  // =====================================================
  function triggerLocalScan(){
    const r = getCurrentRoute();
    if(r.level !== 'L2' || !r.dk || !r.mk){
      alert("è¯·å…ˆè¿›å…¥ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶å¤¹ï¼ˆä¾‹å¦‚ã€å‡ºè·å†™çœŸã€‘ï¼‰åå†ç‚¹å‡»æœ¬åœ°æ‰«æã€‚");
      return;
    }
    dirPicker.value = '';
    dirPicker.click();
  }

  dirPicker.addEventListener('change', (e)=>{
    const route = getCurrentRoute();
    if(route.level !== 'L2' || !route.dk || !route.mk) return;

    const dk = route.dk;
    const mk = route.mk;

    const fileList = [...(e.target.files || [])];
    if(fileList.length === 0) return;

    const results = [];
    for(const f of fileList){
      const rel = (f.webkitRelativePath || f.name).replace(/\\/g,'/');

      let kind = null;
      let after = null;

      const idxImg = rel.indexOf('/images/');
      const idxPdf = rel.indexOf('/pdfs/');

      if(idxImg >= 0){
        kind = 'images';
        after = rel.slice(idxImg + '/images/'.length);
      }else if(idxPdf >= 0){
        kind = 'pdfs';
        after = rel.slice(idxPdf + '/pdfs/'.length);
      }else{
        if(rel.startsWith('images/')){
          kind='images'; after = rel.slice('images/'.length);
        }else if(rel.startsWith('pdfs/')){
          kind='pdfs'; after = rel.slice('pdfs/'.length);
        }else{
          const extGuess = (rel.split('.').pop() || '').toLowerCase();
          kind = (extGuess === 'pdf') ? 'pdfs' : 'images';
          after = rel;
        }
      }

      if(!kind || !after) continue;
      after = normalize(after);

      const ext = (after.split('.').pop() || '').toLowerCase();
      if(kind === 'pdfs' && ext !== 'pdf') continue;
      if(kind === 'images' && !isImageExt(ext)) continue;

      // âœ… å¼ºåˆ¶æ•´ç†æˆï¼šimages/è®¾å¤‡å/... æˆ– pdfs/è®¾å¤‡å/...
const devFolder = getDeviceFolderName(dk);

// å¦‚æœ after å·²ç»ä»¥ â€œè®¾å¤‡å/â€ å¼€å¤´ï¼Œå°±ä¸é‡å¤åŠ 
const firstSeg = (after.split('/')[0] || '').trim();
if(firstSeg !== devFolder){
  after = `${devFolder}/${after}`;
}

const path = `${kind}/${after}`;

      const title = baseNameNoExt(after) || after;

      results.push({ path, ext, title });
    }

    if(results.length === 0){
      alert("æ²¡æœ‰æ‰«åˆ°å¯ç”¨æ–‡ä»¶ã€‚\nå»ºè®®ä½ é€‰æ‹©åŒ…å« images æˆ– pdfs çš„ç›®å½•ï¼Œæˆ–é€‰æ‹©è®¾å¤‡ç›®å½•ï¼ˆimages/è®¾å¤‡å æˆ– pdfs/è®¾å¤‡åï¼‰ã€‚");
      return;
    }

    const mod = EQUIPMENT_DATA[dk].modules[mk];
    mod.subcomponents = mod.subcomponents || {};

    let added = 0;
    for(const it of results){
      const subKey = 'sub_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      mod.subcomponents[subKey] = {
        name: it.title,
        processes: [{ name: it.title, file: it.path, ext: it.ext }]
      };
      added++;
    }

    handleRoute();
    alert(`å·²è¿½åŠ åˆ°å½“å‰æ–‡ä»¶å¤¹ï¼š${added} ä¸ªæ–‡ä»¶ã€‚\nä¸‹ä¸€æ­¥ï¼šç‚¹å³ä¸Šè§’ ğŸ’¾ å¯¼å‡ºï¼Œè¦†ç›– data.jsã€‚`);
  });
</script>
</body>
</html>
